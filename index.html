<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NSE Portfolio — Local PIN Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass { background: rgba(255,255,255,0.75); backdrop-filter: blur(6px); }
    .muted { color: rgba(17,24,39,0.6); }
    .small { font-size: 0.85rem; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 6px; }
    table { border-collapse: collapse; width: 100%; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-sky-50 flex items-center justify-center p-6">
  <div class="w-full max-w-6xl">
    <div class="grid grid-cols-12 gap-6">

      <!-- Left: Auth -->
      <div class="col-span-12 md:col-span-4">
        <div id="authCard" class="glass rounded-2xl p-6 shadow-lg">
          <div id="authView">
            <h2 class="text-2xl font-semibold mb-2">Welcome</h2>
            <p class="muted mb-4">Sign in with a username and 4-digit PIN (stored only in your browser).</p>

            <form id="authForm" class="space-y-3">
              <label class="block text-sm">Username
                <input id="username" class="mt-1 w-full rounded-md border-gray-200 shadow-sm p-2" placeholder="yourname" autocomplete="username" required />
              </label>
              <label class="block text-sm">4-digit PIN
                <input id="pin" type="number" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="mt-1 w-full rounded-md border-gray-200 shadow-sm p-2" placeholder="1234" required />
              </label>

              <div class="flex gap-2">
                <button id="btnRegister" type="button" class="flex-1 py-2 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">Register</button>
                <button id="btnLogin" type="button" class="flex-1 py-2 rounded-lg border bg-white">Login</button>
              </div>

              <div class="text-xs muted">If you are registering for the first time, press <strong>Register</strong>. PINs are stored locally using browser storage.</div>
            </form>

            <div id="authMsg" class="mt-3 text-sm text-red-600"></div>
          </div>

          <div id="userPanel" class="hidden">
            <div class="flex items-center justify-between">
              <div>
                <div id="displayUser" class="font-medium text-lg">—</div>
                <div id="statusMsg" class="text-sm muted">Portfolio ready</div>
              </div>
              <div class="flex gap-2">
                <button id="btnChangePin" class="py-2 px-3 rounded-lg bg-yellow-400 text-black">Change PIN</button>
                <button id="btnLogout" class="py-2 px-3 rounded-lg border bg-white">Logout</button>
              </div>
            </div>

            <div class="mt-4 space-y-2">
              <button id="btnAdd" class="w-full py-2 rounded-lg bg-sky-600 text-white">Add stock</button>
              <button id="btnFetchAll" class="w-full py-2 rounded-lg border bg-white">Refresh prices</button>
              <div class="flex gap-2">
                <button id="btnImport" class="flex-1 py-2 rounded-lg border bg-white">Import JSON</button>
                <button id="btnExport" class="flex-1 py-2 rounded-lg border bg-white">Export</button>
              </div>
            </div>

            <input id="fileInput" type="file" accept="application/json" class="hidden" />

            <div class="mt-6 text-xs muted">
              <strong>Note:</strong> Live prices come from Google Finance. The app first attempts a direct fetch — if blocked by CORS the app uses a safe proxy fallback.
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Portfolio -->
      <div class="col-span-12 md:col-span-8">
        <div id="portfolioCard" class="glass rounded-2xl p-6 shadow-lg hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">Your Portfolio</h3>
            <div class="text-sm muted">Updated: <span id="lastUpdated">-</span></div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-left table-auto border border-slate-200">
              <thead>
                <tr class="text-sm text-slate-600 bg-slate-100 border-b">
                  <th>Stock</th>
                  <th>Qty</th>
                  <th>Buy</th>
                  <th>Live</th>
                  <th>Invested</th>
                  <th>Current</th>
                  <th>P/L%</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tblBody" class="text-sm"></tbody>
              <tfoot class="text-sm font-medium bg-slate-50 border-t">
                <tr>
                  <td colspan="4">Totals</td>
                  <td id="totInvested">-</td>
                  <td id="totCurrent">-</td>
                  <td id="totPL">-</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="mt-4 text-xs muted">Tip: Use Import/Export to backup your portfolio file.</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const USER_KEY = 'nse_app_users_v1';
    const STORAGE_PREFIX = 'nse_portfolio_user_';

    const $ = id => document.getElementById(id);
    const format = n => (Number.isFinite(n) ? n.toFixed(2) : '-');

    function saveUsers(obj){ localStorage.setItem(USER_KEY, JSON.stringify(obj)); }
    function loadUsers(){ return JSON.parse(localStorage.getItem(USER_KEY) || '{}'); }
    function savePortfolioForUser(username, portfolio){ localStorage.setItem(STORAGE_PREFIX + username, JSON.stringify(portfolio)); }
    function loadPortfolioForUser(username){ try{ return JSON.parse(localStorage.getItem(STORAGE_PREFIX + username) || '[]'); } catch(e){ return []; } }

    let currentUser = null;
    let portfolio = [];

    function showAuth(){ $('authView').classList.remove('hidden'); $('userPanel').classList.add('hidden'); $('portfolioCard').classList.add('hidden'); }
    function showUserPanel(){ $('authView').classList.add('hidden'); $('userPanel').classList.remove('hidden'); $('portfolioCard').classList.remove('hidden'); }

    document.addEventListener('DOMContentLoaded', () => {
      const usernameEl = $('username'); const pinEl = $('pin');
      $('btnRegister').onclick = () => {
        const u = usernameEl.value.trim(); const pin = pinEl.value.trim();
        if(!u || !pin){ $('authMsg').textContent = 'Enter username and 4-digit PIN'; return; }
        if(pin.length < 4){ $('authMsg').textContent = 'PIN must be 4 digits'; return; }
        const users = loadUsers(); if(users[u]){ $('authMsg').textContent = 'Username exists'; return; }
        users[u] = btoa(pin); saveUsers(users); $('authMsg').style.color='green'; $('authMsg').textContent='Registered. Now press Login.';
      };
      $('btnLogin').onclick = () => {
        const u=usernameEl.value.trim(); const pin=pinEl.value.trim();
        const users=loadUsers(); if(users[u]&&users[u]===btoa(pin)){ currentUser=u; $('displayUser').textContent=u; showUserPanel(); } else $('authMsg').textContent='Invalid username or PIN';
      };
      $('btnLogout').onclick = ()=>{currentUser=null; showAuth();};

      $('btnChangePin').onclick = ()=>{
        const newPin = prompt('Enter new 4-digit PIN');
        if(newPin && newPin.length===4){ const users=loadUsers(); users[currentUser]=btoa(newPin); saveUsers(users); alert('PIN changed successfully'); }
        else alert('Invalid PIN format');
      };
      showAuth();
    });
  </script>
</body>
</html>
