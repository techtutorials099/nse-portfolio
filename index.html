<!doctype html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NSE Portfolio ‚Äî Your Portfolio + IPOs</title>
  <meta name="description" content="Client-side NSE portfolio + IPO tracker (current week + upcoming) with auto-fetch and manual edit." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg1: #eef9f6; --bg2:#f1f8ff; --card: rgba(255,255,255,0.92); --muted: rgba(17,24,39,0.6);
      --accent-1: rgba(199,236,234,0.9); --accent-2: rgba(224,235,255,0.9); --accent-3: rgba(243,238,255,0.9);
    }
    .dark{--bg1:#071020;--bg2:#08111a;--card:rgba(10,16,22,0.85);--muted:rgba(203,213,225,0.7);}
    body{background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;font-family:Inter,system-ui,Arial;}
    .glass{background:var(--card);backdrop-filter:blur(6px);border-radius:14px}
    .muted{color:var(--muted)}
    table{border-collapse:collapse;width:100%;font-size:0.95rem}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(0,0,0,0.06)}
    .dark th,.dark td{border-bottom:1px solid rgba(255,255,255,0.04)}
    thead th{background:linear-gradient(90deg,var(--accent-2),var(--accent-3));position:sticky;top:0;z-index:2}
    tbody tr:nth-child(odd){background:linear-gradient(90deg,rgba(255,255,255,0.012),transparent)}
    tfoot td{font-weight:700;background:linear-gradient(90deg,var(--accent-1),var(--accent-2))}
    .profit{color:#0f9d58;font-weight:600}
    .loss{color:#e53935;font-weight:600}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab-active{background:linear-gradient(90deg,#e0f7fa,#e8f0ff);box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .fab{position:fixed;right:18px;bottom:18px;z-index:80;width:56px;height:56px;border-radius:999px;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(2,6,23,0.12)}
    @media(min-width:768px){.sticky-aside{position:sticky;top:28px}}
  </style>
</head>
<body class="p-4 sm:p-6">
  <div class="max-w-7xl mx-auto">
    <div class="flex gap-4 items-center mb-4">
      <h1 class="text-2xl font-semibold">Your Portfolio</h1>
      <div class="ml-4 flex gap-2">
        <div id="tabPortfolio" class="tab tab-active">Portfolio</div>
        <div id="tabIPO" class="tab">IPO Tracker</div>
      </div>
      <div class="ml-auto muted text-sm">Updated: <span id="globalUpdated">-</span></div>
    </div>

    <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-6">
      <!-- Left: Auth -->
      <aside class="md:w-4/12">
        <div class="glass p-5 shadow sticky-aside">
          <p class="muted text-sm">Sign in with username + 4-digit PIN (stored locally).</p>
          <form id="authForm" class="mt-3 space-y-3" onsubmit="return false;">
            <label class="block text-sm">Username
              <input id="username" class="mt-1 w-full rounded-md border p-2" placeholder="yourname" autocomplete="username" />
            </label>
            <label class="block text-sm">PIN
              <input id="pin" type="password" maxlength="4" class="mt-1 w-full rounded-md border p-2" placeholder="1234" />
            </label>
            <div class="flex gap-2">
              <button id="btnRegister" type="button" class="flex-1 py-2 rounded-md bg-emerald-500 text-white">Register</button>
              <button id="btnLogin" type="button" class="flex-1 py-2 rounded-md border">Login</button>
            </div>
            <div id="authMsg" class="text-sm text-red-600"></div>
          </form>

          <div id="userPanel" class="hidden mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div id="displayUser" class="font-medium"></div>
                <div id="statusMsg" class="muted text-sm">Choose a tab to begin.</div>
              </div>
              <div class="flex items-center gap-2">
                <button id="themeToggle" class="p-2 rounded-md border">üåô</button>
                <button id="btnSettings" class="p-2 rounded-md border">‚öôÔ∏è</button>
                <button id="btnLogout" class="py-2 px-3 rounded-md border">Logout</button>
              </div>
            </div>

            <div class="mt-4 space-y-2">
              <button id="btnAdd" class="w-full py-2 rounded-md bg-sky-500 text-white">Add stock</button>
              <button id="btnFetchAll" class="w-full py-2 rounded-md border">Refresh prices</button>
              <div class="flex gap-2">
                <button id="btnImport" class="flex-1 py-2 rounded-md border">Import</button>
                <button id="btnExport" class="flex-1 py-2 rounded-md border">Export</button>
              </div>
            </div>

            <input id="fileInput" type="file" accept="application/json" class="hidden" />
            <div class="mt-3 text-xs muted">Prices via Google Finance (AllOrigins). IPOs auto-fetch (current week + upcoming).</div>
          </div>
        </div>
      </aside>

      <!-- Right: content area -->
      <main class="md:w-8/12">
        <!-- Portfolio Card -->
        <div id="portfolioCard" class="glass p-5 shadow">
          <div id="portfolioArea">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">Holdings</h2>
              <div class="muted text-sm">Last: <span id="lastUpdated">-</span></div>
            </div>
            <div class="overflow-auto">
              <table id="portfolioTable" class="min-w-[720px]">
                <thead>
                  <tr>
                    <th>Stock</th><th>Qty</th><th>Buy ‚Çπ</th><th>Live ‚Çπ</th><th>Invested ‚Çπ</th>
                    <th>Current ‚Çπ</th><th>P&L ‚Çπ</th><th>P/L %</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tblBody"></tbody>
                <tfoot>
                  <tr id="totalsRow">
                    <td colspan="4">Totals</td>
                    <td id="totInvested">-</td>
                    <td id="totCurrent">-</td>
                    <td id="totPLRs">-</td>
                    <td id="totPLPerc">-</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- IPO Area (hidden by default) -->
          <div id="ipoArea" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">IPO Tracker ‚Äî Current week + upcoming</h2>
              <div class="flex items-center gap-2">
                <input id="ipoSearch" placeholder="Search company or status" class="rounded-md border p-2 text-sm" />
                <button id="btnIpoRefresh" class="py-2 px-3 rounded-md border">Refresh IPOs</button>
              </div>
            </div>

            <div class="overflow-auto">
              <table id="ipoTable" class="min-w-[720px]">
                <thead>
                  <tr>
                    <th>Company</th><th>Issue ‚Çπ</th><th>GMP ‚Çπ</th><th>Open</th><th>Close</th><th>Listing</th><th>Status</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody id="ipoBody"></tbody>
                <tfoot>
                  <tr>
                    <td colspan="8" class="muted text-sm">Auto-fetched from public IPO calendars. GMP live-fetch is best-effort; you can edit values manually.</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- FAB -->
  <button id="fabAdd" class="fab bg-sky-500 text-white hidden" title="Add" aria-label="Add">+</button>

  <!-- Add/Edit Stock Modal -->
  <div id="modalWrap" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-5 max-w-md w-full">
      <h3 id="modalTitle" class="font-semibold mb-2">Add stock</h3>
      <div class="space-y-3">
        <label class="block text-sm">Symbol
          <input id="mSymbol" list="sugStocks" class="mt-1 w-full rounded-md border p-2" placeholder="RELIANCE" />
          <datalist id="sugStocks"><option value="RELIANCE"></option><option value="TCS"></option><option value="INFY"></option></datalist>
        </label>
        <label class="block text-sm">Quantity
          <input id="mQty" type="number" min="1" class="mt-1 w-full rounded-md border p-2" value="1" />
        </label>
        <label class="block text-sm">Buy price ‚Çπ
          <input id="mBuy" type="number" step="0.01" class="mt-1 w-full rounded-md border p-2" />
        </label>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="px-4 py-2 rounded-md border">Cancel</button>
        <button id="modalSave" class="px-4 py-2 rounded-md bg-sky-500 text-white">Save</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit IPO Modal -->
  <div id="ipoModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-5 max-w-md w-full">
      <h3 id="ipoModalTitle" class="font-semibold mb-2">Add IPO</h3>
      <div class="space-y-3">
        <label class="block text-sm">Company
          <input id="iCompany" class="mt-1 w-full rounded-md border p-2" placeholder="Company Ltd" />
        </label>
        <label class="block text-sm">Issue Price ‚Çπ
          <input id="iIssue" type="number" step="0.01" class="mt-1 w-full rounded-md border p-2" />
        </label>
        <label class="block text-sm">GMP ‚Çπ
          <input id="iGmp" type="number" step="0.01" class="mt-1 w-full rounded-md border p-2" />
        </label>
        <label class="block text-sm">Open Date
          <input id="iOpen" type="date" class="mt-1 w-full rounded-md border p-2" />
        </label>
        <label class="block text-sm">Close Date
          <input id="iClose" type="date" class="mt-1 w-full rounded-md border p-2" />
        </label>
        <label class="block text-sm">Listing Date
          <input id="iListing" type="date" class="mt-1 w-full rounded-md border p-2" />
        </label>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="ipoCancel" class="px-4 py-2 rounded-md border">Cancel</button>
        <button id="ipoSave" class="px-4 py-2 rounded-md bg-sky-500 text-white">Save IPO</button>
      </div>
    </div>
  </div>

<script>
/* App with IPO auto-fetch (current week + upcoming) */
const PROXY = 'https://api.allorigins.win/raw?url=';
const USER_KEY = 'nse_app_users_v5';
const STORAGE_PREFIX = 'nse_portfolio_user_v5_';
const IPO_STORE = 'nse_ipos_v5_';
const THEME_KEY = 'nse_theme_v5';
const AUTO_REFRESH_MS = 5 * 60 * 1000;
const IPO_DAILY_REFRESH = 24 * 60 * 60 * 1000;

const $ = id => document.getElementById(id);

function saveUsers(obj){ localStorage.setItem(USER_KEY, JSON.stringify(obj)); }
function loadUsers(){ return JSON.parse(localStorage.getItem(USER_KEY) || '{}'); }
function savePortfolioForUser(username, portfolio){ localStorage.setItem(STORAGE_PREFIX + username, JSON.stringify(portfolio)); }
function loadPortfolioForUser(username){ try{return JSON.parse(localStorage.getItem(STORAGE_PREFIX + username) || '[]')}catch(e){return []} }
function saveIPOForUser(username, data){ localStorage.setItem(IPO_STORE + username, JSON.stringify({ts:Date.now(), data})); }
function loadIPOForUser(username){ try{ const raw = localStorage.getItem(IPO_STORE + username); if(!raw) return {ts:0,data:[]}; return JSON.parse(raw); }catch(e){return {ts:0,data:[]};} }

async function fetchPrice(symbol){
  try{
    const url = PROXY + encodeURIComponent(`https://www.google.com/finance/quote/${symbol}:NSE`);
    const res = await fetch(url);
    if(!res.ok) throw new Error('network');
    const html = await res.text();
    const m = html.match(/class="YMlKec fxKbKc"[^>]*>([^<]+)</);
    if(m && m[1]){ const raw = m[1].replace(/[^0-9.,]/g,'').replace(/,/g,''); const v=parseFloat(raw); if(Number.isFinite(v)) return v; }
    return null;
  }catch(e){ console.warn('fetch error', e); return null; }
}

// naive parser for chittorgarh upcoming page (best-effort)
async function fetchIPOsFromChittorgarh(){
  const url = 'https://www.chittorgarh.com/ipo/upcoming-ipo/';
  try{
    const res = await fetch(PROXY + encodeURIComponent(url));
    if(!res.ok) throw new Error('network');
    const html = await res.text();
    const rows = [];
    const trRegex = /<tr[^>]*>([\s\S]*?)<\/tr>/gi;
    let match;
    while((match = trRegex.exec(html))){
      const txt = match[1].replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
      if(txt.match(/\d{2}-\w{3}-\d{4}/) || txt.match(/\bIPO\b/i)){
        rows.push(txt);
      }
    }
    const ipos = [];
    rows.slice(0,40).forEach(r=>{
      const name = r.split(' - ')[0].slice(0,80);
      const dateMatch = r.match(/(\d{1,2}\-\w{3}\-\d{4})/);
      const open = dateMatch ? parseChittoDate(dateMatch[0]) : null;
      const priceMatch = r.match(/(\d{1,4}(?:,\d{3})*(?:\.\d+)?\s*(?:to|-)\s*\d{1,4}(?:,\d{3})*(?:\.\d+)?)/);
      const issue = priceMatch ? priceMatch[0].replace(/,/g,'') : '';
      ipos.push({company:name.trim(), issue: issue, gmp:null, open: open, close:null, listing:null, status:'Upcoming', source:'chittorgarh'});
    });
    return ipos;
  }catch(e){ console.warn('chitto fetch failed', e); return []; }
}

function parseChittoDate(s){
  try{
    const parts = s.split('-');
    if(parts.length!==3) return null;
    const d = parseInt(parts[0],10);
    const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].indexOf(parts[1]);
    const y = parseInt(parts[2],10);
    if(m<0) return null;
    return new Date(y,m,d);
  }catch(e){return null;}
}

async function fetchIPOsFromMoneycontrol(){
  const url = 'https://www.moneycontrol.com/stocks/marketstats/ipo/';
  try{
    const res = await fetch(PROXY + encodeURIComponent(url));
    if(!res.ok) throw new Error('network');
    const html = await res.text();
    const ipos = [];
    const lines = html.split('\n').slice(0,800).join(' ');
    const regex = /<a[^>]*href="[^"]*ipo[^"]*"[^>]*>([^<]{3,80})<\/a>/gi;
    let m;
    while((m = regex.exec(lines))){
      const name = m[1].trim();
      ipos.push({company:name, issue:'', gmp:null, open:null, close:null, listing:null, status:'Upcoming', source:'moneycontrol'});
    }
    return ipos;
  }catch(e){ console.warn('moneycontrol fetch failed', e); return []; }
}

function filterRelevantIPOs(ipos){
  const now = new Date();
  const weekStart = new Date(now); weekStart.setDate(now.getDate() - now.getDay());
  const futureLimit = new Date(now); futureLimit.setDate(now.getDate() + 30);
  return ipos.filter(i => {
    if(!i.open && !i.close && !i.listing) return true;
    const candidateDates = [i.open, i.close, i.listing].filter(Boolean);
    for(const d of candidateDates){
      const dt = new Date(d);
      if(dt >= weekStart && dt <= futureLimit) return true;
    }
    return false;
  });
}

async function autoFetchIPOs(){
  let ipos = [];
  try{ const fromChit = await fetchIPOsFromChittorgarh(); if(fromChit && fromChit.length) ipos = ipos.concat(fromChit); }catch(e){}
  try{ const fromMc = await fetchIPOsFromMoneycontrol(); if(fromMc && fromMc.length) ipos = ipos.concat(fromMc); }catch(e){}
  const map = {};
  ipos.forEach(i => {
    const k = (i.company || '').toLowerCase().replace(/\s+/g,' ').trim();
    if(!k) return;
    if(!map[k]) map[k] = i;
  });
  const merged = Object.values(map);
  const relevant = filterRelevantIPOs(merged);
  return relevant;
}

// ---------- Portfolio code ----------
async function fetchPriceSafe(symbol){ return await fetchPrice(symbol); }

let currentUser = null, portfolio = [], editIndex = null, autoTimer = null;

function renderPortfolio(){
  const tbody = $('tblBody'); tbody.innerHTML=''; let invested=0,current=0,plrs=0;
  portfolio.forEach((it, idx) => {
    const live = it.live || it.buy || 0;
    const investedRow = it.qty * it.buy;
    const currentRow = it.qty * live;
    const plValue = currentRow - investedRow;
    invested += investedRow; current += currentRow; plrs += plValue;
    const plPerc = it.buy ? ((live - it.buy)/it.buy*100) : 0;
    const tr = document.createElement('tr');
    const plClass = plValue >= 0 ? 'profit' : 'loss';
    tr.innerHTML = `<td class="font-medium">${it.symbol}</td><td>${it.qty}</td><td>${fmt(it.buy)}</td><td id="live-${idx}">${fmt(live)}</td><td>${fmt(investedRow)}</td><td>${fmt(currentRow)}</td><td class="${plClass}">${fmt(plValue)}</td><td class="${plClass}">${plPerc.toFixed(2)}%</td><td><button data-i="${idx}" class="px-2 py-1 rounded-md border fetchBtn">Refresh</button> <button data-i="${idx}" class="px-2 py-1 rounded-md border editBtn">Edit</button> <button data-i="${idx}" class="px-2 py-1 rounded-md border text-red-600 delBtn">Del</button></td>`;
    tbody.appendChild(tr);
  });
  $('totInvested').textContent = fmt(invested);
  $('totCurrent').textContent = fmt(current);
  $('totPLRs').textContent = fmt(plrs);
  const totPerc = invested ? ((current - invested)/invested*100) : 0;
  $('totPLPerc').textContent = totPerc.toFixed(2) + '%';
  document.querySelectorAll('.delBtn').forEach(b => b.onclick = e => { const i = +e.target.dataset.i; portfolio.splice(i,1); savePortfolioForUser(currentUser, portfolio); renderPortfolio(); });
  document.querySelectorAll('.editBtn').forEach(b => b.onclick = e => { openEdit(+e.target.dataset.i); });
  document.querySelectorAll('.fetchBtn').forEach(b => b.onclick = async e => {
    const i = +e.target.dataset.i; const s = portfolio[i].symbol; const old = portfolio[i].live || portfolio[i].buy;
    const p = await fetchPriceSafe(s);
    if(p !== null){ portfolio[i].live = p; savePortfolioForUser(currentUser, portfolio); flashPrice(i, old, p); renderPortfolio(); $('lastUpdated').textContent = new Date().toLocaleString(); $('globalUpdated').textContent = new Date().toLocaleString(); }
    else alert('Price fetch failed for ' + s);
  });
}

function flashPrice(idx, oldPrice, newPrice){
  const el = $('live-' + idx); if(!el) return;
  if(newPrice > oldPrice) { el.classList.add('profit'); setTimeout(()=>el.classList.remove('profit'),900); }
  else if(newPrice < oldPrice){ el.classList.add('loss'); setTimeout(()=>el.classList.remove('loss'),900); }
}

async function loadAndFetchAll(){
  portfolio = loadPortfolioForUser(currentUser) || []; renderPortfolio();
  for(let i=0;i<portfolio.length;i++){
    try{
      const old = portfolio[i].live || portfolio[i].buy;
      const p = await fetchPriceSafe(portfolio[i].symbol);
      if(p!==null){ portfolio[i].live = p; flashPrice(i, old, p); }
    }catch(e){ console.warn(e); }
  }
  savePortfolioForUser(currentUser, portfolio); renderPortfolio(); $('lastUpdated').textContent = new Date().toLocaleString(); $('globalUpdated').textContent = new Date().toLocaleString();
}

// ---------- IPO rendering ----------
let ipoData = [];

function renderIPOs(filterText=''){
  const tbody = $('ipoBody'); tbody.innerHTML='';
  const ft = (filterText||'').toLowerCase();
  ipoData.forEach((it, idx) => {
    if(ft && !((it.company||'').toLowerCase().includes(ft) || (it.status||'').toLowerCase().includes(ft))) return;
    const open = it.open ? new Date(it.open).toLocaleDateString() : '-';
    const close = it.close ? new Date(it.close).toLocaleDateString() : '-';
    const listing = it.listing ? new Date(it.listing).toLocaleDateString() : '-';
    const gmpClass = (it.gmp || 0) >= 0 ? 'profit' : 'loss';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="font-medium">${it.company}</td><td>${it.issue || '-'}</td><td class="${gmpClass}">${it.gmp!==null?fmt(it.gmp):'-'}</td><td>${open}</td><td>${close}</td><td>${listing}</td><td>${it.status||'-'}</td><td><button data-i="${idx}" class="px-2 py-1 rounded-md border editIpo">Edit</button> <button data-i="${idx}" class="px-2 py-1 rounded-md border delIpo text-red-600">Del</button></td>`;
    tbody.appendChild(tr);
  });
}

function openAddIPO(){ $('ipoModal').classList.remove('hidden'); $('ipoModalTitle').textContent='Add IPO'; $('iCompany').value=''; $('iIssue').value=''; $('iGmp').value=''; $('iOpen').value=''; $('iClose').value=''; $('iListing').value=''; window.currentIpoEdit = null; }
function openEditIPO(i){ const it = ipoData[i]; $('ipoModal').classList.remove('hidden'); $('ipoModalTitle').textContent='Edit IPO'; $('iCompany').value=it.company||''; $('iIssue').value=it.issue||''; $('iGmp').value=it.gmp||''; $('iOpen').value=it.open? (new Date(it.open)).toISOString().slice(0,10):''; $('iClose').value=it.close? (new Date(it.close)).toISOString().slice(0,10):''; $('iListing').value=it.listing? (new Date(it.listing)).toISOString().slice(0,10):''; window.currentIpoEdit = i; }

document.addEventListener('click', (e) => {
  if(e.target && e.target.classList.contains('editIpo')){
    openEditIPO(+e.target.dataset.i);
  }
  if(e.target && e.target.classList.contains('delIpo')){
    const i = +e.target.dataset.i;
    if(confirm('Delete IPO?')){ ipoData.splice(i,1); saveIPOForUser(currentUser,ipoData); renderIPOs($('ipoSearch').value); }
  }
});

function toNum(v){ const n = parseFloat(v); return Number.isFinite(n)?n:null; }

document.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem(THEME_KEY) || 'light'; applyTheme(savedTheme);

  const tabP = $('tabPortfolio'), tabI = $('tabIPO');
  function showPortfolioTab(){ tabP.classList.add('tab-active'); tabI.classList.remove('tab-active'); $('portfolioArea').style.display='block'; $('ipoArea').style.display='none'; updateFabForTab('portfolio'); }
  function showIPOTab(){ tabI.classList.add('tab-active'); tabP.classList.remove('tab-active'); $('portfolioArea').style.display='none'; $('ipoArea').style.display='block'; updateFabForTab('ipo'); }
  tabP.onclick = showPortfolioTab; tabI.onclick = showIPOTab;

  const usernameEl = $('username'), pinEl = $('pin');
  $('btnRegister').onclick = () => {
    const u = usernameEl.value.trim(); const pin = pinEl.value.trim();
    if(!u||!pin){ $('authMsg').textContent='Enter username and PIN'; return; }
    if(pin.length<4){ $('authMsg').textContent='PIN must be 4 digits'; return; }
    const users = loadUsers(); if(users[u]){ $('authMsg').textContent='Username exists'; return; }
    users[u] = btoa(pin); saveUsers(users); $('authMsg').style.color='green'; $('authMsg').textContent='Registered ‚Äî press Login'; setTimeout(()=>$('authMsg').textContent='',2000);
  };
  $('btnLogin').onclick = async () => {
    const u = usernameEl.value.trim(); const pin = pinEl.value.trim();
    $('authMsg').textContent='';
    if(!u||!pin){ $('authMsg').textContent='Enter username and PIN'; return; }
    const users = loadUsers();
    if(users[u] && users[u] === btoa(pin)){
      currentUser = u; $('displayUser').textContent = u; $('authForm').classList.add('hidden'); $('userPanel').classList.remove('hidden');
      portfolio = loadPortfolioForUser(currentUser) || []; renderPortfolio();
      const iposRaw = loadIPOForUser(currentUser); ipoData = iposRaw.data || [];
      if(!iposRaw.ts || (Date.now() - iposRaw.ts) > IPO_DAILY_REFRESH){
        await refreshIPOs(true);
      } else {
        renderIPOs('');
      }
      showPortfolioTab();
      if(autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(()=>loadAndFetchAll(), AUTO_REFRESH_MS);
    } else {
      $('authMsg').textContent='Invalid username or PIN';
    }
  };

  $('btnLogout').onclick = () => { currentUser=null; portfolio=[]; ipoData=[]; if(autoTimer) clearInterval(autoTimer); $('authForm').classList.remove('hidden'); $('userPanel').classList.add('hidden'); $('portfolioArea').style.display='block'; $('ipoArea').style.display='none'; };

  $('btnSettings').onclick = () => { if(!currentUser){ alert('Login first'); return; } $('pinModal').classList.remove('hidden'); $('curPin').value=''; $('newPin').value=''; $('confirmPin').value=''; };
  $('pinCancel').onclick = () => $('pinModal').classList.add('hidden');
  $('pinSave').onclick = () => {
    const cur = $('curPin').value.trim(); const nw = $('newPin').value.trim(); const cf = $('confirmPin').value.trim();
    if(!cur||!nw||!cf){ alert('Enter all fields'); return; } if(nw.length<4||cf.length<4){ alert('PIN must be 4 digits'); return; }
    const users = loadUsers();
    if(!users[currentUser] || users[currentUser] !== btoa(cur)){ alert('Current PIN incorrect'); return; }
    if(nw!==cf){ alert('New PIN and confirm do not match'); return; }
    users[currentUser] = btoa(nw); saveUsers(users); alert('PIN changed'); $('pinModal').classList.add('hidden');
  };

  $('themeToggle').onclick = () => { const now = document.documentElement.classList.contains('dark')? 'light' : 'dark'; applyTheme(now); };

  $('btnAdd').onclick = openAdd;
  $('fabAdd').onclick = () => { if(tabI.classList.contains('tab-active')) openAddIPO(); else openAdd(); };
  $('modalCancel').onclick = () => $('modalWrap').classList.add('hidden');
  $('modalSave').onclick = async () => {
    const s = $('mSymbol').value.trim().toUpperCase(); const q = parseFloat($('mQty').value); const b = parseFloat($('mBuy').value);
    if(!s||!(q>0)||!(b>0)){ alert('Enter valid values'); return; }
    const entry = {symbol:s, qty:q, buy:b};
    if(editIndex===null) portfolio.push(entry); else portfolio[editIndex]=Object.assign(portfolio[editIndex], entry);
    savePortfolioForUser(currentUser, portfolio); $('modalWrap').classList.add('hidden'); renderPortfolio();
    const idx = editIndex===null? portfolio.length-1: editIndex;
    const p = await fetchPriceSafe(portfolio[idx].symbol);
    if(p!==null){ portfolio[idx].live = p; savePortfolioForUser(currentUser, portfolio); renderPortfolio(); $('lastUpdated').textContent=new Date().toLocaleString(); $('globalUpdated').textContent=new Date().toLocaleString(); }
  };

  $('ipoCancel').onclick = () => $('ipoModal').classList.add('hidden');
  $('ipoSave').onclick = () => {
    const comp = $('iCompany').value.trim(); const issue = $('iIssue').value.trim(); const gmp = toNum($('iGmp').value); const open = $('iOpen').value; const close = $('iClose').value; const listing = $('iListing').value;
    if(!comp){ alert('Enter company name'); return; }
    const obj = {company:comp, issue:issue, gmp: gmp===null? null: gmp, open: open||null, close: close||null, listing: listing||null, status: 'Manual'};
    if(window.currentIpoEdit===null) ipoData.push(obj); else ipoData[window.currentIpoEdit] = obj;
    saveIPOForUser(currentUser, ipoData); $('ipoModal').classList.add('hidden'); renderIPOs($('ipoSearch').value);
  };

  $('btnIpoRefresh').onclick = async () => { await refreshIPOs(true); };

  $('ipoSearch').addEventListener('input', e => renderIPOs(e.target.value));

  $('btnExport').onclick = () => {
    if(!currentUser){ alert('Login first'); return; }
    const data = loadPortfolioForUser(currentUser)||[]; const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = currentUser + '-portfolio.json'; a.click(); URL.revokeObjectURL(url);
  };
  $('btnImport').onclick = () => $('fileInput').click();
  $('fileInput').onchange = e => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = () => { try{ const d = JSON.parse(r.result); if(Array.isArray(d)){ portfolio = d; savePortfolioForUser(currentUser, portfolio); renderPortfolio(); alert('Imported'); } else alert('Invalid JSON'); }catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); };

  async function refreshIPOs(force=false){
    if(!currentUser) { alert('Login first'); return; }
    $('statusMsg').textContent = 'Fetching IPOs...';
    try{
      const fetched = await autoFetchIPOs();
      const saved = loadIPOForUser(currentUser).data || [];
      const map = {};
      saved.forEach(s => { map[(s.company||'').toLowerCase()] = s; });
      fetched.forEach(f => { const k = (f.company||'').toLowerCase(); if(!map[k]) map[k]=f; });
      ipoData = Object.values(map);
      saveIPOForUser(currentUser, ipoData);
      renderIPOs('');
      $('statusMsg').textContent = 'IPOs updated';
      $('globalUpdated').textContent = new Date().toLocaleString();
    }catch(e){
      console.warn(e); $('statusMsg').textContent = 'Failed to fetch IPOs'; alert('Failed to fetch IPOs (see console)');
    }
  }

  function updateFabForTab(tab){
    if(tab==='ipo'){ $('fabAdd').classList.remove('hidden'); $('fabAdd').setAttribute('title','Add IPO'); }
    else { $('fabAdd').classList.remove('hidden'); $('fabAdd').setAttribute('title','Add stock'); }
  }

  window.$ = $;
  const pref = localStorage.getItem(THEME_KEY) || 'light'; applyTheme(pref);
  function updateFAB(){ if(window.innerWidth < 768){ $('fabAdd').classList.remove('hidden'); } else { $('fabAdd').classList.add('hidden'); } }
  updateFAB(); window.addEventListener('resize', updateFAB);
});
</script>
</body>
</html>
